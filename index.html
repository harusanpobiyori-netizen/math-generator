<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>算数プリント自動生成</title>
  <style>
    body{
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      margin: 16px;
    }
    .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .card{ border:1px solid #ddd; border-radius:10px; padding:12px; margin-bottom:12px; }
    label{ margin-right: 8px; }
    input[type="number"]{ width: 110px; padding: 6px; }
    button{ padding: 8px 12px; cursor:pointer; }
    .meta{ font-size: 12px; color:#444; }
    #sheet{ margin-top: 16px; }
    .sheet-head{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .title{ font-size: 22px; font-weight: 800; }

    /* ===== 氏名・日付（画面でも大きめ） ===== */
    .namebox{
      border: 2px solid #000;
      border-radius: 10px;
      padding: 12px 14px;
      min-width: 320px;
    }
    .name-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    .name-label{
      font-size: 18px;
      font-weight: 700;
      white-space: nowrap;
    }
    .line{
      flex:1;
      border-bottom: 2px solid #000;
      height: 0;
      transform: translateY(2px);
    }

    /* ===== 問題レイアウト ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px 22px;
      margin-top: 18px;
    }
    .q{
      display:flex;
      align-items:flex-end;
      gap: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #000;
      font-size: 20px;
      line-height: 1.8;
      white-space: nowrap;
    }

    /* 番号：式と混同しないように「枠付き・小さめ・色味」 */
    .qn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 40px;
      height: 34px;
      padding: 0 10px;
      border: 2px solid #000;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 800;
      line-height: 1;
      background: #fff;
      flex: 0 0 auto;
    }
    .qe{
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .hidden{ display:none; }

    /* ===== 印刷用（高齢者向け：さらに大きい文字・広い行間） ===== */
    @media print{
      body{ margin:0; }
      .no-print{ display:none !important; }
      #sheet{ padding: 20mm 18mm; border:none; margin:0; }
      .title{ font-size: 24px; }
      .namebox{
        min-width: 0;
        width: 100%;
        padding: 14px 16px;
        border-width: 3px;
      }
      .name-label{ font-size: 20px; }
      .line{ border-bottom-width: 3px; }

      .grid{ gap: 18px 26px; }
      .q{
        font-size: 24px;
        line-height: 2.0;
        padding-bottom: 12px;
        border-bottom-width: 3px;
      }
      .qn{
        min-width: 44px;
        height: 38px;
        border-width: 3px;
        font-size: 16px; /* 番号は式より小さく固定 */
      }
      .qe{
        font-size: 26px;
        font-weight: 800;
      }

      .answers-grid{
        display:grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 14px 22px;
        margin-top: 14px;
        font-size: 20px;
        line-height: 1.9;
      }
    }
  </style>
</head>
<body>
  <!-- 操作パネル（seedは見せない） -->
  <div class="card no-print">
    <div class="row">
      <strong>算数プリント生成</strong>
      <span class="meta">過去30日重複なし（端末内）／解答別紙印刷／印刷時は条件非表示</span>
    </div>
    <hr />
    <div class="row">
      <span>演算：</span>
      <label><input type="checkbox" id="opAdd" checked>＋</label>
      <label><input type="checkbox" id="opSub" checked>－</label>
      <label><input type="checkbox" id="opMul">×</label>
      <label><input type="checkbox" id="opDiv">÷</label>
    </div>

    <div class="row" style="margin-top:8px;">
      <label>数字上限：
        <input type="number" id="maxNum" value="100" min="5" max="99999" />
      </label>
      <label>問題数：
        <input type="number" id="count" value="20" min="5" max="200" />
      </label>
      <label>列数：
        <input type="number" id="cols" value="4" min="1" max="6" />
      </label>
    </div>

    <div class="row" style="margin-top:8px;">
      <label><input type="checkbox" id="noCarry">（＋）繰り上がりなし</label>
      <label><input type="checkbox" id="noBorrow">（－）繰り下がりなし</label>
      <label><input type="checkbox" id="divExact" checked>（÷）割り切れるのみ</label>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnGen">生成</button>
      <button id="btnPrintQ">問題を印刷/保存(PDF)</button>
      <button id="btnPrintA">解答を印刷/保存(PDF)</button>
      <button id="btnClearHistory" title="この端末の過去履歴を消去します">履歴クリア</button>
    </div>

    <!-- 画面上のみ条件表示（印刷には出さない） -->
    <div class="meta" id="metaLineScreen" style="margin-top:8px;"></div>
  </div>

  <!-- 問題用紙 -->
  <div id="sheet" class="card">
    <div class="sheet-head">
      <div>
        <div class="title">算数プリント</div>
      </div>

      <!-- 氏名・日付：大きく -->
      <div class="namebox">
        <div class="name-row">
          <div class="name-label">氏名</div>
          <div class="line"></div>
        </div>
        <div class="name-row" style="margin-bottom:0;">
          <div class="name-label">日付</div>
          <div class="line"></div>
        </div>
      </div>
    </div>

    <div id="grid" class="grid"></div>

    <!-- 解答用紙（印刷時のみ表示させる運用） -->
    <div id="answerSheet" class="hidden" style="margin-top:22px;">
      <div class="title">解答</div>
      <div id="answersGrid" class="answers-grid"></div>
    </div>
  </div>

<script>
/* ========= seed付き乱数（内部のみ：UIに出さない） ========= */
function xfnv1a(str) {
  let h = 2166136261 >>> 0;
  for (let i=0; i<str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32(a) {
  return function() {
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
function autoSeed() {
  return String(Date.now()) + '-' + Math.floor(Math.random() * 1e9);
}
function randInt(rng, min, max) { // inclusive
  return Math.floor(rng() * (max - min + 1)) + min;
}
function pick(rng, arr) {
  return arr[Math.floor(rng() * arr.length)];
}

/* ========= 過去30日重複ゼロ（端末内履歴） ========= */
const HISTORY_KEY = 'math_gen_history_v1';
const DAYS_30_MS = 30 * 24 * 60 * 60 * 1000;

function loadHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
  catch { return []; }
}
function saveHistory(list) {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
}
function pruneHistory(list) {
  const now = Date.now();
  return list.filter(x => (now - x.time) <= DAYS_30_MS);
}
function hashStr(s){
  let h = 2166136261>>>0;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h,16777619);
  }
  return h>>>0;
}

/* ========= 条件系ユーティリティ ========= */
function getOps() {
  const ops = [];
  if (document.getElementById('opAdd').checked) ops.push('+');
  if (document.getElementById('opSub').checked) ops.push('-');
  if (document.getElementById('opMul').checked) ops.push('*');
  if (document.getElementById('opDiv').checked) ops.push('/');
  return ops;
}
function hasCarry(a, b) {
  while (a > 0 || b > 0) {
    if ((a % 10) + (b % 10) >= 10) return true;
    a = Math.floor(a / 10);
    b = Math.floor(b / 10);
  }
  return false;
}
function hasBorrow(a, b) {
  let borrow = 0;
  while (a > 0 || b > 0) {
    const ad = (a % 10) - borrow;
    const bd = (b % 10);
    if (ad < bd) return true;
    borrow = 0;
    a = Math.floor(a / 10);
    b = Math.floor(b / 10);
  }
  return false;
}

/* ========= 問題生成（条件を満たすまでリトライ） ========= */
function genOne(rng, op, maxNum, noCarry, noBorrow, divExact) {
  const MAX_TRY = 2500;
  for (let t=0; t<MAX_TRY; t++) {
    let a, b, ans, disp, key;

    if (op === '+') {
      a = randInt(rng, 0, maxNum);
      b = randInt(rng, 0, maxNum);
      if (noCarry && hasCarry(a, b)) continue;
      ans = a + b;
      const x = Math.min(a, b), y = Math.max(a, b); // 足し算は正規化
      key = `+:${x},${y}`;
      disp = `${a} + ${b} =`;
      return { key, disp, ans };

    } else if (op === '-') {
      a = randInt(rng, 0, maxNum);
      b = randInt(rng, 0, maxNum);
      if (b > a) [a, b] = [b, a]; // マイナス回避
      if (noBorrow && hasBorrow(a, b)) continue;
      ans = a - b;
      key = `-:${a},${b}`;
      disp = `${a} - ${b} =`;
      return { key, disp, ans };

    } else if (op === '*') {
      const lim = Math.max(5, Math.floor(Math.sqrt(maxNum)));
      a = randInt(rng, 0, lim);
      b = randInt(rng, 0, lim);
      ans = a * b;
      if (ans > maxNum) continue;
      key = `*:${a},${b}`;
      disp = `${a} × ${b} =`;
      return { key, disp, ans };

    } else if (op === '/') {
      if (divExact) {
        const d = randInt(rng, 1, Math.max(2, Math.min(12, maxNum)));
        const q = randInt(rng, 0, Math.max(2, Math.min(12, maxNum)));
        a = d * q; b = d;
        if (a > maxNum) continue;
        ans = q;
        key = `/:${a},${b}`;
        disp = `${a} ÷ ${b} =`;
        return { key, disp, ans };
      } else {
        b = randInt(rng, 1, Math.max(2, Math.min(12, maxNum)));
        a = randInt(rng, 0, maxNum);
        const q = Math.floor(a / b);
        const r = a % b;
        ans = `${q} あまり ${r}`;
        key = `/%:${a},${b}`;
        disp = `${a} ÷ ${b} =（商　　余り　　）`;
        return { key, disp, ans };
      }
    }
  }
  return null;
}

/* ========= 表示 ========= */
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

let lastAnswers = [];

function genSheet() {
  const ops = getOps();
  if (ops.length === 0) { alert('演算を1つ以上選択してください'); return; }

  const maxNum = Number(document.getElementById('maxNum').value);
  const count  = Number(document.getElementById('count').value);
  const cols   = Number(document.getElementById('cols').value);
  const noCarry  = document.getElementById('noCarry').checked;
  const noBorrow = document.getElementById('noBorrow').checked;
  const divExact = document.getElementById('divExact').checked;

  // seedは内部自動
  const seedStr = autoSeed();
  const rng = mulberry32(xfnv1a(seedStr));

  // 履歴（過去30日）
  let hist = pruneHistory(loadHistory());
  const histSet = new Set(hist.map(x => x.h));

  const usedInThisSheet = new Set();
  const qs = [];
  const answers = [];

  const MAX_TRY_TOTAL = 70000;
  let tries = 0;

  while (qs.length < count && tries < MAX_TRY_TOTAL) {
    tries++;
    const op = pick(rng, ops);
    const q = genOne(rng, op, maxNum, noCarry, noBorrow, divExact);
    if (!q) continue;

    const h = hashStr(q.key);
    if (histSet.has(h)) continue;
    if (usedInThisSheet.has(h)) continue;

    usedInThisSheet.add(h);
    qs.push(q.disp);
    answers.push(q.ans);
  }

  if (qs.length < count) {
    alert('条件が厳しすぎて十分な問題数を生成できませんでした。\n上限や制約（繰り上がり/繰り下がり等）を緩めてください。');
  }

  // 問題表示（番号を枠に入れて混同回避）
  const grid = document.getElementById('grid');
  grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  grid.innerHTML = qs.map((s, i) => `
    <div class="q">
      <span class="qn">No.${i+1}</span>
      <span class="qe">${escapeHtml(s)}</span>
    </div>
  `).join('');

  // 解答（別紙）
  lastAnswers = answers.slice();
  const answersGrid = document.getElementById('answersGrid');
  answersGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  answersGrid.innerHTML = answers.map((a,i)=>`<div><strong>No.${i+1}</strong>　${escapeHtml(a)}</div>`).join('');

  // 画面上だけ条件表示（印刷には出ない）
  const opLabel = ops.map(o=>o==='*'?'×':o==='/'?'÷':o).join('・');
  document.getElementById('metaLineScreen').textContent =
    `条件（画面のみ）：演算=${opLabel} / 上限=${maxNum} / 問題数=${count} / 列=${cols}`;

  // 履歴保存
  const now = Date.now();
  const add = Array.from(usedInThisSheet).map(h => ({ h, time: now }));
  hist = pruneHistory(hist.concat(add));
  saveHistory(hist);
}

/* ========= 印刷（問題/解答 別ページ） ========= */
function showAnswerSheet(show) {
  const el = document.getElementById('answerSheet');
  if (show) el.classList.remove('hidden');
  else el.classList.add('hidden');
}
document.getElementById('btnPrintQ').addEventListener('click', () => {
  showAnswerSheet(false);
  window.print();
});
document.getElementById('btnPrintA').addEventListener('click', () => {
  if (!lastAnswers.length) genSheet();
  showAnswerSheet(true);
  window.print();
  showAnswerSheet(false);
});

/* ========= 履歴クリア ========= */
document.getElementById('btnClearHistory').addEventListener('click', () => {
  if (!confirm('この端末の出題履歴（過去30日分）を削除します。よろしいですか？')) return;
  localStorage.removeItem(HISTORY_KEY);
  alert('履歴を削除しました。');
});

/* ========= 生成ボタン ========= */
document.getElementById('btnGen').addEventListener('click', genSheet);

// 初期表示
genSheet();
</script>
</body>
</html>
